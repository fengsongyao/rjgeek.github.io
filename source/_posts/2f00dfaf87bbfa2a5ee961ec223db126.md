---
title: 【Mongodb】Mongodb查询优化一合理利用片键
id: 57
categories:
  - 数据库知识
date: 2014-12-11 17:43:34
tags:
---

<div>
</div><div>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border: none;"><tbody></tbody></table></div><div>

<table class="MsoTableGrid" border="1" cellspacing="0" cellpadding="0" style="border: none;">
 <tbody><tr>
  <td width="151" valign="top" style="width: 90.45pt; border-color: windowtext; border-width: 1pt; padding: 0cm 5.4pt;">
  <!--more-->

**<span style="font-size:12.0pt;font-family:
  宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">指标项</span>**<span lang="EN-US" style="font-family: Arial, sans-serif;"><o:p></o:p></span>

  </td>
  <td width="559" valign="top" style="width: 335.65pt; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-style: none; padding: 0cm 5.4pt;">

**<span style="font-size:12.0pt;font-family:
  宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">具体说明</span>**<span lang="EN-US" style="font-family: Arial, sans-serif;"><o:p></o:p></span>

  </td>
 </tr>
 <tr>
  <td width="151" valign="top" style="width: 90.45pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">当前数据量<span lang="EN-US"><o:p></o:p></span></span>

  </td>
  <td width="559" valign="top" style="width: 335.65pt; border-top-style: none; border-left-style: none; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-color: windowtext; border-right-width: 1pt; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">单个集合<span lang="EN-US">100G<o:p></o:p></span></span>

  </td>
 </tr>
 <tr>
  <td width="151" valign="top" style="width: 90.45pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">优化结果<span lang="EN-US"><o:p></o:p></span></span>

  </td>
  <td width="559" valign="top" style="width: 335.65pt; border-top-style: none; border-left-style: none; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-color: windowtext; border-right-width: 1pt; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">目前查询平均相应时间小于<span lang="EN-US">20s<o:p></o:p></span></span>

  </td>
 </tr>
 <tr>
  <td width="151" valign="top" style="width: 90.45pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">最优查询方式<span lang="EN-US"><o:p></o:p></span></span>

  </td>
  <td width="559" valign="top" style="width: 335.65pt; border-top-style: none; border-left-style: none; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-color: windowtext; border-right-width: 1pt; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">切换到需要查询的单位，选择时间间隔，输入其他查询条件<span lang="EN-US"><o:p></o:p></span></span>

  </td>
 </tr>
 <tr>
  <td width="151" valign="top" style="width: 90.45pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">必要说明<span lang="EN-US"><o:p></o:p></span></span>

  </td>
  <td width="559" valign="top" style="width: 335.65pt; border-top-style: none; border-left-style: none; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-color: windowtext; border-right-width: 1pt; padding: 0cm 5.4pt;">

<span lang="EN-US" style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;
  mso-font-kerning:0pt">1.</span><span style="font-size:12.0pt;font-family:
  宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">查询时间间隔越小，速度越快，<span lang="EN-US"><o:p></o:p></span></span>

<span lang="EN-US" style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;
  mso-font-kerning:0pt">2.</span><span style="font-size:12.0pt;font-family:
  宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">查询同一家单位首次查询速度最慢，查询次数越多，速度越快<span lang="EN-US">&nbsp; &nbsp; &nbsp;&nbsp;<o:p></o:p></span></span>

<span lang="EN-US" style="font-size:12.0pt;
  font-family:宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">3.</span><span style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;mso-font-kerning:
  0pt">数据库多线程每个<span lang="EN-US">15</span>秒批量插入一次，在数据库插入的同一时间点去查询，速度会较慢<span lang="EN-US"><o:p></o:p></span></span>

  </td>
 </tr>
 <tr>
  <td width="151" valign="top" style="width: 90.45pt; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; padding: 0cm 5.4pt;">

<span style="font-size:12.0pt;font-family:宋体;
  mso-bidi-font-family:宋体;mso-font-kerning:0pt">优化过程<span lang="EN-US"><o:p></o:p></span></span>

  </td>
  <td width="559" valign="top" style="width: 335.65pt; border-top-style: none; border-left-style: none; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-color: windowtext; border-right-width: 1pt; padding: 0cm 5.4pt;">

<span lang="EN-US" style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;
  mso-font-kerning:0pt">1.</span><span style="font-size:12.0pt;font-family:
  宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">去除所有模糊查询【全表扫描】；<span lang="EN-US"><o:p></o:p></span></span>

<span lang="EN-US" style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;
  mso-font-kerning:0pt">2.</span><span style="font-size:12.0pt;font-family:
  宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">优化查询<span lang="EN-US">json</span>串，【去除<span lang="EN-US">KEY</span>中双引号，速度有明显提升，原因不明】，<span lang="EN-US"><o:p></o:p></span></span>

<span lang="EN-US" style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;
  mso-font-kerning:0pt">3.</span><span style="font-size:12.0pt;font-family:
  宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">利用联合索引中单位<span lang="EN-US">ID</span>字段并与其他字段组合【<span lang="EN-US">B</span>树扫描】，<span lang="EN-US"><o:p></o:p></span></span>

<span lang="EN-US" style="font-size:12.0pt;
  font-family:宋体;mso-bidi-font-family:宋体;mso-font-kerning:0pt">4.</span><span style="font-size:12.0pt;font-family:宋体;mso-bidi-font-family:宋体;mso-font-kerning:
  0pt">利用索引总按照时间倒序的规律【<span lang="EN-US">B</span>树扫描】<span lang="EN-US"><o:p></o:p></span></span>

  </td>
 </tr>
</tbody></table></div><div>
</div><div>
</div><div>1.查询最优图示：</div><div>
</div><div>![0N9$D3%1Y~KVJ2R$GDG@)ZU.png](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_36d47459-a5e4-435a-a019-afd3aa9ad8e5.png)
</div><div>
</div><div>2.生产环境10点左右查询，时间显示</div><div>
</div><div>![3.bmp](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_e76dbc99-8679-439d-9ef7-322eaf6823a7.bmp)
</div><div>![111.bmp](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_95c8a9c0-0da9-4216-9bd8-2c781285f1e1.bmp)
</div><div>
</div><div>3.查询JSON字符串优化前后对比图</div><div>
</div><div>![FH@05Q`HD)9OIT_9CGCFO[9.jpg](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_67b8e8f2-81d2-40d7-8c06-48b8f6639bc9.jpg)![[C_K4U64E1]H{HO`{(W(W{A.jpg](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_cada9c3b-6cbb-4fa2-bdcc-b0d88c144941.jpg)</div><div>
</div><div><span style="font-size: 10.5pt; line-height: 1.5;">4.生产环境优化前后，平均时间对比</span></div><div>![P`~D22H4YKSC$8Y00TLWV{U.png](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_ef05be57-c55c-424a-a768-488920703e1d.png)
</div><div>
</div><div>
</div>

<div>[来自为知笔记(Wiz)](http://www.wiz.cn/i/60efacb7 "来自为知笔记(Wiz)")</div>

<div>

### 附件列表

*   [[C_K4U64E1]H{HO`{(W(W{A.jpg](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_C_K4U64E1HHOWWA.jpg)
*   [[C_K4U64E1]H{HO`{(W(W{A_2.jpg](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_C_K4U64E1HHOWWA_2.jpg)
*   [0N9$D3%1Y~KVJ2R$GDG@)ZU.png](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_0N9D3%1YKVJ2RGDG@ZU.png)
*   [111.bmp](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_111.bmp)
*   [3.bmp](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_3.bmp)
*   [FH@05Q`HD)9OIT_9CGCFO[9.jpg](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_FH@05QHD9OIT_9CGCFO9.jpg)
*   [FH@05Q`HD)9OIT_9CGCFO[9_2.jpg](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_FH@05QHD9OIT_9CGCFO9_2.jpg)
*   [P`~D22H4YKSC$8Y00TLWV{U.png](http://helloword.1kapp.com/wp-content/uploads/2015/12/wpid-12b45b80b162bb572027a83698960c26_PD22H4YKSC8Y00TLWVU.png)</div>

&nbsp;