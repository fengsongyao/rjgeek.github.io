---
title: 【系统架构】数据库常见架构分析
tags:
  - 数据库知识
id: 587
categories:
  - 数据库知识
date: 2015-11-16 15:41:45
---

<div id="page-content"><div id="img-content">

## 
<!--more--><div id="js_content">

<font face="微软雅黑, Microsoft YaHei, Georgia, Helvetica, Arial, sans-serif, 宋体, PMingLiU, serif"><span style="font-size: 14px; line-height: 21px;">数据库常见架构分析</span></font>

* * *

1.基本概念

1.1 单库

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_B127C6FBBF69F6F7EFA53E9CBE3EEAEA.png)

单张表支撑所有业务，一旦异常，后果严重。

* * *

1.2&nbsp;<span style="font-size: 10.5pt; line-height: 1.5;">分片</span>

<span style="font-size: 10.5pt; line-height: 1.5;">
</span>

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5316.png)

<div>
</div>分片解决的是“数据量太大”的问题，也就是通常说的“水平切分”。

一旦引入分片，势必有“数据路由”的概念，哪个数据访问哪个库。

针对个别的数据库，也支持表级的分片，如mongodb
<div>

路由规则通常有3种方法：

（1）范围：range

优点：简单，容易扩展

缺点：各库压力不均（新号段更活跃）

（2）哈希：hash

优点：简单，数据均衡，负载均匀

缺点：迁移麻烦（2库扩3库数据要迁移）

（3）路由服务：router-config-server

优点：灵活性强，业务与路由算法解耦

缺点：每次访问数据库前多一次查询

* * *

1.3 分组

<span style="font-size: 10.5pt; line-height: 1.5;">分组解决“可用性”问题，分组通常通过主从复制的方式实现。</span>

<span style="font-size: 10.5pt; line-height: 1.5;">
</span>

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5317.png)

互联网公司数据库实际软件架构是：又分片，又分组（如下图）

</div>![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5318.png)</div><div id="js_content">
</div><div id="js_content">
</div><div id="js_content">

* * *

2、数据库架构设计需要考虑的方向

<span style="font-size: 10.5pt; line-height: 1.5;">2.1数据的可用性</span>

解决可用性问题的思路是=&gt;冗余

如何保证站点的可用性？复制站点，冗余站点

如何保证服务的可用性？复制服务，冗余服务

如何保证数据的可用性？复制数据，冗余数据

<span style="font-size: 10.5pt; line-height: 1.5;">数据的冗余，会带来一个副作用=&gt;引发一致性问题（先不说一致性问题，先说可用性）</span>

<span style="font-size: 10.5pt; line-height: 1.5;">如何保证数据库“读”高可用？</span>

冗余读库

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5319.png)

写入单台机器中，另外两台根据日志去同步主数据库，<span style="font-size: 10.5pt; line-height: 1.5;">读写有延时，可能不一致</span>

<span style="font-size: 10.5pt; line-height: 1.5;">写仍然是单点，不能保证写高可用，</span><span style="font-size: 10.5pt; line-height: 1.5;">如何保证数据库“写”高可用？</span>

<span style="font-size: 10.5pt; line-height: 1.5;">冗余写库</span>

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5320.png)

采用双主互备的方式，可以冗余写库

带来的副作用？双写同步，数据可能冲突（例如“自增id”同步冲突）,如何解决同步冲突，有两种常见解决方案：

（1）两个写库使用<span style="font-size: 10.5pt; line-height: 1.5;">不同的初始值，相同的步长来增加id：1写库的id为0,2,4,6...；2写库的id为1,3,5,7…</span>

（2）不使用数据的id，业务层自己生成唯一的id，保证数据不冲突

<span style="font-size: 10.5pt; line-height: 1.5;">双主当主从用</span>

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5321.png)
仍是双主，但只有一个主提供服务（读+写），另一个主是“shadow-master”，只用来保证高可用，平时不提供服务。

master挂了，shadow-master顶上（vip漂移，对业务层透明，不需要人工介入）

这种方式的好处：

1）读写没有延时

2）读写高可用

不足：

1）不能通过加从库的方式扩展读性能

2）资源利用率为50%，一台冗余主没有提供服务

<span style="font-size: 10.5pt; line-height: 1.5;">那如何提高读性能呢？进入第二个话题，如何提供读性能。</span>

* * *

2.2数据库的拓展性

提高读性能的方式大致有三种

第一种是建立索引。这种方式不展开，要提到的一点是，不同的库可以建立不同的索引。

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5322.png)

写库不建立索引；

线上读库建立线上访问索引，例如uid；

线下读库建立线下访问索引，例如time；

第二种扩充读性能的方式是，增加从库，这种方法大家用的比较多，但是，存在两个缺点：

（1）从库越多，同步越慢

（2）同步越慢，数据不一致窗口越大（不一致后面说，还是先说读性能的提高）

<span style="font-size: 10.5pt; line-height: 1.5;">第三种 服务+数据库+缓存一套</span>

<span style="font-size: 10.5pt; line-height: 1.5;">
</span>

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5324.png)

业务层不直接面向db和cache，服务层屏蔽了底层db、cache的复杂性。为什么要引入服务层，今天不展开，58采用了“服务+数据库+缓存一套”的方式提供数据访问，用cache提高读性能。

<span style="font-size: 10.5pt; line-height: 1.5;">不管采用主从的方式扩展读性能，还是缓存的方式扩展读性能，数据都要复制多份（主+从，db+cache），一定会引发一致性问题。</span>

* * *

<div>

2.3数据库的一致性

主从数据库的一致性，通常有两种解决方案：

（1）中间件

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5325.png)

如果某一个key有写操作，在不一致时间窗口内，中间件会将这个key的读操作也路由到主库上。

常见的组件有 Atlas<span style="font-size: 10.5pt; line-height: 1.5;">，cobar，TDDL</span>

（2）强制读主

第二类不一致，是db与缓存间的不一致

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5326.png)
常见的缓存架构如上，此时<font face="宋体">写操作的顺序是</font>：

（1）淘汰cache

（2）写数据库

读操作的顺序是：

（1）读cache，如果cache hit则返回

（2）如果cache miss，则读从库

（3）读从库后，将数据放回cache

<span style="font-size: 10.5pt; line-height: 1.5;">在一些异常时序情况下，有可能从【从库读到旧数据（同步还没有完成），旧数据入cache后】，数据会长期不一致。</span>

<span style="font-size: 10.5pt; line-height: 1.5;">解决办法是“缓存双淘汰”，写操作时序升级为：</span>

（1）淘汰cache

（2）写数据库

（3）在经验“主从同步延时窗口时间”后，再次发起一个异步淘汰cache的请求

这样，即使有脏数据如cache，一个小的时间窗口之后，脏数据还是会被淘汰。带来的代价是，多引入一次读miss（成本可以忽略）。

<span style="font-size: 10.5pt; line-height: 1.5;">建议为所有cache中的item设置一个超时时间。</span>

<span style="font-size: 10.5pt; line-height: 1.5;">
</span>

* * *

2.4数据库的拓展性

如何秒级扩容？

首先，我们不做2库变3库的扩容，我们做2库变4库（库加倍）的扩容（未来4-&gt;8-&gt;16）

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5327.png)

服务+数据库是一套（省去了缓存）

数据库采用“双主”的模式。

扩容步骤：

第一步，将一个主库提升

第二步，修改配置，2库变4库（原来MOD2，现在配置修改后MOD4）

扩容完成

![](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_IMG_5328.png)

原MOD2为偶的部分，现在会MOD4余0或者2

原MOD2为奇的部分，现在会MOD4余1或者3

数据不<span style="font-size: 10.5pt; line-height: 1.5;">需要迁移，同时，双主互相同步，一遍是余0，一边余2，两边数据同步也不会冲突，秒级完成扩容！</span>

最后，要做一些收尾工作：

（1）将旧的双主同步解除

（2）增加新的双主（双主是保证可用性的，shadow-master平时不提供服务）

（3）删除多余的数据（余0的主，可以将余2的数据删除掉）

![91A4C8CDA901CF30766E1D2636751444.png](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_7162ae61-1406-4459-9516-5c230ac871fc.png)
</div><div>
</div>
这样，秒级别内，我们就完成了2库变4库的扩展。</div><div id="js_content">
</div><div id="js_content">
</div><div id="js_content">

* * *

最后感谢58同城架构师 沈剑 的分享！
<div>
</div>
<div>
</div>
<div>
</div>

</div></div></div><div id="js_pc_qr_code" style="font-family: 微软雅黑, 'Microsoft YaHei', Georgia, Helvetica, Arial, sans-serif, 宋体, PMingLiU, serif; font-size: 14px; line-height: 21px;">&nbsp;</div>

<div>[来自为知笔记(Wiz)](http://www.wiz.cn/i/60efacb7 "来自为知笔记(Wiz)")</div>

<div>

### 附件列表

*   [b4b787a3-4d55-4db4-9d90-aba34f1aaa93.png](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_b4b787a3-4d55-4db4-9d90-aba34f1aaa93.png)
*   [a13eb93f-e69c-4f1c-9ada-ce5d1c63ae2b.png](http://helloword.1kapp.com/wp-content/uploads/2015/11/wpid-292bef3af3dc7d82c8876d3b531478a5_a13eb93f-e69c-4f1c-9ada-ce5d1c63ae2b.png)</div>

&nbsp;